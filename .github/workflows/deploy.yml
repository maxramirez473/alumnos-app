name: ï¿½ Create Release Version

# Ejecutar solo en push a main y cuando los tests pasen
on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["ğŸ§ª Laravel Testing Suite"]
    types: [completed]
    branches: [ main ]

jobs:
  # Job para crear release automÃ¡tico
  release:
    # Solo ejecutar si los tests pasaron
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    name: ğŸ“¦ Create Release
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para obtener todos los tags

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, sqlite3

    - name: ğŸ“Š Generate Demo Statistics
      run: |
        echo "ğŸ“ˆ Generando estadÃ­sticas de la aplicaciÃ³n demo..."
        
        # Contar archivos de cÃ³digo
        PHP_FILES=$(find . -name "*.php" -not -path "./vendor/*" | wc -l)
        TEST_FILES=$(find ./tests -name "*.php" | wc -l)
        CONTROLLERS=$(find ./app/Http/Controllers -name "*.php" | wc -l)
        MODELS=$(find ./app/Models -name "*.php" | wc -l)
        
        # Contar lÃ­neas de cÃ³digo (aproximado)
        LINES_OF_CODE=$(find . -name "*.php" -not -path "./vendor/*" -exec wc -l {} + | tail -1 | awk '{print $1}')
        
        echo "ğŸ” ESTADÃSTICAS DE LA DEMO:"
        echo "- Archivos PHP: $PHP_FILES"
        echo "- Archivos de test: $TEST_FILES"
        echo "- Controladores: $CONTROLLERS"  
        echo "- Modelos: $MODELS"
        echo "- LÃ­neas de cÃ³digo: ~$LINES_OF_CODE"
        echo ""
        
        # Crear archivo de estadÃ­sticas
        cat > demo-stats.md << EOF
        # ğŸ“Š EstadÃ­sticas de la AplicaciÃ³n Demo
        
        ## ğŸ“ˆ MÃ©tricas de CÃ³digo
        - **Archivos PHP**: $PHP_FILES
        - **Archivos de Test**: $TEST_FILES  
        - **Controladores**: $CONTROLLERS
        - **Modelos**: $MODELS
        - **LÃ­neas de CÃ³digo**: ~$LINES_OF_CODE
        
        ## ğŸ§ª Cobertura de Testing
        - Tests Unitarios (Caja Blanca)
        - Tests de API (Caja Negra)
        - Tests de IntegraciÃ³n
        - Tests End-to-End (E2E)
        - Tests de Seguridad
        
        ## ğŸ—ï¸ Arquitectura
        - Laravel 11.x
        - PHP 8.2+
        - SQLite/MySQL
        - Bootstrap 5
        - GitHub Actions CI/CD
        
        Generado automÃ¡ticamente el $(date)
        EOF

    - name: ğŸ“Š Generate Changelog
      id: changelog
      run: |
        # Obtener el Ãºltimo tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
        
        if [ -z "$LAST_TAG" ]; then
          echo "ğŸ“ No hay tags previos - generando changelog desde el primer commit"
          # Si no hay tags, obtener todos los commits
          CHANGELOG=$(git log --pretty=format:"- %s (%an)" --no-merges --max-count=20)
        else
          echo "ğŸ“ Ãšltimo tag encontrado: $LAST_TAG"
          # Generar changelog desde el Ãºltimo tag
          CHANGELOG=$(git log $LAST_TAG..HEAD --pretty=format:"- %s (%an)" --no-merges)
        fi
        
        # Si no hay commits nuevos, mostrar mensaje por defecto
        if [ -z "$CHANGELOG" ]; then
          CHANGELOG="- Despliegue de mantenimiento (Sin cambios significativos)"
        fi
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ğŸ“‹ Upload Demo Statistics
      uses: actions/upload-artifact@v3
      with:
        name: demo-statistics-v${{ github.run_number }}
        path: demo-stats.md

    - name: ğŸ·ï¸ Create Release
      if: github.ref == 'refs/heads/main'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: "ğŸ“¦ Demo Release v${{ github.run_number }}"
        body: |
          ## ğŸ¯ Sistema de GestiÃ³n de Alumnos - VersiÃ³n de DemostraciÃ³n
          
          ### ğŸš€ Cambios en esta versiÃ³n:
          ${{ steps.changelog.outputs.changelog }}
          
          ### ğŸ§ª Estado de Testing:
          - âœ… Tests unitarios (Caja Blanca): Pasaron
          - âœ… Tests de API (Caja Negra): Pasaron  
          - âœ… Tests de integraciÃ³n: Pasaron
          - âœ… Tests de comportamiento (E2E): Pasaron
          - âœ… Tests de seguridad: Pasaron
          
          ### ğŸ“‹ Funcionalidades incluidas:
          - ğŸ‘¥ GestiÃ³n completa de alumnos
          - ğŸ« AdministraciÃ³n de grupos
          - ğŸ“Š Reportes y bÃºsquedas
          - ğŸ” Sistema de autenticaciÃ³n
          - ğŸ“¡ API REST completa
          - ğŸ§ª Suite de testing integral
          
          ### ğŸ”— Enlaces Ãºtiles:
          - [ğŸ“‚ Ver todos los commits](https://github.com/${{ github.repository }}/commits/main)
          - [ğŸ§ª Ver suite de testing](https://github.com/${{ github.repository }}/tree/main/tests)
          - [ğŸ“– DocumentaciÃ³n](https://github.com/${{ github.repository }}/blob/main/README.md)
          
          ### ğŸ’» Para desarrolladores:
          ```bash
          git clone https://github.com/${{ github.repository }}.git
          cd alumnos-app
          composer install
          php artisan migrate --seed
          php artisan test
          ```
          
          ---
          ğŸ“ **AplicaciÃ³n de demostraciÃ³n educativa - No desplegada en producciÃ³n**
        draft: false
        prerelease: false

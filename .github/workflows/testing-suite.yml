name: ğŸ§ª Suite Completa de Testing

# Ejecuta en cada push y pull request
on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ejecuta tests diariamente a las 2 AM UTC
    - cron: '0 2 * * *'

# Permite ejecutar manualmente
workflow_dispatch:

jobs:
  # ==========================================
  # JOB 1: TESTING UNITARIO (Caja Blanca)
  # ==========================================
  unit-tests:
    name: ğŸ”¬ Testing Unitario (Caja Blanca)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: [8.1, 8.2, 8.3]
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: xdebug

      - name: ğŸ“¦ Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ matrix.php-version }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-php-${{ matrix.php-version }}-composer-

      - name: ğŸ”§ Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest --no-interaction

      - name: ğŸ“ Prepare Laravel Application
        run: |
          cp .env.testing .env
          php artisan key:generate
          php artisan config:clear
          php artisan cache:clear

      - name: ğŸ—„ï¸ Create SQLite Database
        run: |
          mkdir -p database
          touch database/database.sqlite

      - name: ğŸ§ª Execute Unit Tests (Caja Blanca)
        run: |
          echo "ğŸ”¬ Ejecutando Testing Unitario - Caja Blanca"
          echo "Conocemos la implementaciÃ³n interna de los modelos"
          vendor/bin/phpunit tests/Unit --coverage-text --colors=never
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite

  # ==========================================
  # JOB 2: TESTING DE INTEGRACIÃ“N
  # ==========================================
  integration-tests:
    name: ğŸ”— Testing de IntegraciÃ³n
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testing
          MYSQL_DATABASE: alumnos_testing
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, mysql, pdo_mysql, bcmath, soap, intl, gd, exif, iconv

      - name: ğŸ“¦ Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: ğŸ”§ Prepare Application
        run: |
          cp .env.testing .env
          php artisan key:generate

      - name: ğŸ—„ï¸ Setup Database
        run: |
          php artisan migrate --force
          php artisan db:seed --force
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: alumnos_testing
          DB_USERNAME: root
          DB_PASSWORD: testing

      - name: ğŸ”— Execute Integration Tests
        run: |
          echo "ğŸ”— Ejecutando Testing de IntegraciÃ³n"
          echo "Probando interacciÃ³n entre Controladores, Modelos y BD"
          vendor/bin/phpunit tests/Feature/AlumnoIntegrationTest.php --colors=never
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: alumnos_testing
          DB_USERNAME: root
          DB_PASSWORD: testing

  # ==========================================
  # JOB 3: TESTING DE API (Caja Negra)
  # ==========================================
  api-tests:
    name: ğŸ“¡ Testing de API (Caja Negra)
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv

      - name: ğŸ“¦ Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: ğŸ”§ Prepare Application
        run: |
          cp .env.testing .env
          php artisan key:generate
          touch database/database.sqlite
          php artisan migrate --force

      - name: ğŸ“¡ Execute API Tests (Caja Negra)
        run: |
          echo "ğŸ“¡ Ejecutando Testing de API - Caja Negra"
          echo "Solo probamos entrada y salida, sin conocer implementaciÃ³n"
          vendor/bin/phpunit tests/Feature/API/AlumnoApiTest.php --colors=never
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite

  # ==========================================
  # JOB 4: TESTING E2E (Comportamiento)
  # ==========================================
  e2e-tests:
    name: ğŸ­ Testing End-to-End (Comportamiento)
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, api-tests]
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv

      - name: ğŸ“¦ Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: ğŸ”§ Prepare Application
        run: |
          cp .env.testing .env
          php artisan key:generate
          touch database/database.sqlite
          php artisan migrate --force

      - name: ğŸ­ Execute E2E Tests (Comportamiento)
        run: |
          echo "ğŸ­ Ejecutando Testing End-to-End"
          echo "Simulando flujos completos de usuario"
          vendor/bin/phpunit tests/Feature/AlumnoBehaviorTest.php --colors=never
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite

  # ==========================================
  # JOB 5: ANÃLISIS DE COBERTURA
  # ==========================================
  coverage-analysis:
    name: ğŸ“Š AnÃ¡lisis de Cobertura
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, api-tests, e2e-tests]
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: xdebug

      - name: ğŸ“¦ Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: ğŸ”§ Prepare Application
        run: |
          cp .env.testing .env
          php artisan key:generate
          touch database/database.sqlite
          php artisan migrate --force

      - name: ğŸ“Š Generate Coverage Report
        run: |
          echo "ğŸ“Š Generando reporte de cobertura completo"
          vendor/bin/phpunit --coverage-html coverage --coverage-clover coverage.xml
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite

      - name: ğŸ“¤ Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: alumnos-app-coverage

      - name: ğŸ“ˆ Coverage Summary
        run: |
          echo "ğŸ“ˆ RESUMEN DE COBERTURA:"
          echo "========================"
          if [ -f coverage.xml ]; then
            echo "âœ… Reporte de cobertura generado exitosamente"
            echo "ğŸ“ Archivos analizados para cobertura"
          else
            echo "âŒ No se pudo generar el reporte de cobertura"
          fi

  # ==========================================
  # JOB 6: REPORTE FINAL Y NOTIFICACIONES
  # ==========================================
  test-summary:
    name: ğŸ“‹ Resumen de Testing
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, api-tests, e2e-tests, coverage-analysis]
    if: always()
    
    steps:
      - name: ğŸ“‹ Generate Test Summary
        run: |
          echo "ğŸ§ª RESUMEN COMPLETO DE TESTING"
          echo "=============================="
          echo ""
          echo "âœ… TIPOS DE TESTING EJECUTADOS:"
          echo "ğŸ”¬ Testing Unitario (Caja Blanca) - Modelos y componentes aislados"
          echo "ğŸ”— Testing de IntegraciÃ³n - InteracciÃ³n entre componentes"
          echo "ğŸ“¡ Testing de API (Caja Negra) - Endpoints REST sin conocer implementaciÃ³n"
          echo "ğŸ­ Testing E2E - Flujos completos de comportamiento de usuario"
          echo "ğŸ“Š AnÃ¡lisis de Cobertura - MÃ©tricas de cÃ³digo cubierto"
          echo ""
          echo "ğŸ¯ PROPÃ“SITO EDUCATIVO:"
          echo "Esta suite demuestra diferentes enfoques de testing:"
          echo "â€¢ Caja Blanca: Conocemos la implementaciÃ³n interna"
          echo "â€¢ Caja Negra: Solo evaluamos entrada y salida"
          echo "â€¢ IntegraciÃ³n: Componentes trabajando juntos"
          echo "â€¢ E2E: Experiencia completa del usuario"
          echo ""
          echo "ğŸ“ˆ BENEFICIOS:"
          echo "â€¢ DetecciÃ³n temprana de errores"
          echo "â€¢ Confianza en el despliegue"
          echo "â€¢ DocumentaciÃ³n viva del comportamiento"
          echo "â€¢ FacilitaciÃ³n del refactoring"
          echo ""
          
          # Determinar el estado general
          if [[ "${{ needs.unit-tests.result }}" == "success" && 
                "${{ needs.integration-tests.result }}" == "success" && 
                "${{ needs.api-tests.result }}" == "success" && 
                "${{ needs.e2e-tests.result }}" == "success" ]]; then
            echo "ğŸ‰ RESULTADO: TODOS LOS TESTS PASARON âœ…"
            echo "La aplicaciÃ³n estÃ¡ lista para producciÃ³n!"
          else
            echo "âŒ RESULTADO: ALGUNOS TESTS FALLARON"
            echo "Revisar los logs de los jobs fallidos."
          fi

      - name: ğŸ”” Notification Status
        run: |
          echo "ğŸ”” Estado para notificaciones:"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "API Tests: ${{ needs.api-tests.result }}"
          echo "E2E Tests: ${{ needs.e2e-tests.result }}"
          echo "Coverage: ${{ needs.coverage-analysis.result }}"
